<!-- sandbox.html -->
<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
</head>
<body>
<script>
    (function () {
        function deepEqual(a, b) {
            if (a === b) return true;
            if (Number.isNaN(a) && Number.isNaN(b)) return true;
            if (typeof a !== typeof b) return false;
            if (a && b && typeof a === 'object') {
                const ka = Object.keys(a), kb = Object.keys(b);
                if (ka.length !== kb.length) return false;
                for (const k of ka) if (!deepEqual(a[k], b[k])) return false;
                return true;
            }
            return false;
        }

        function runWith(globals, code) {
            const names = Object.keys(globals || {});
            const args  = names.map(k => globals[k]);

            const normalized = String(code || '')
                .replace(/\bwindow\.alert\s*\(/g, 'console.log(')
                .replace(/\balert\s*\(/g, 'console.log(');

            const out = [];
            const origLog = console.log;
            console.log = (...xs) => { out.push(xs.length === 1 ? xs[0] : xs.join(' ')); };
            self.__output__ = out;

            try {
                const fn = new Function(...names, '"use strict";\n' + normalized);
                fn(...args);
            } catch (e) {
                out.push('Execution Error: ' + (e && e.message ? e.message : String(e)));
            } finally {
                console.log = origLog;
            }
            return out;
        }

        onmessage = (e) => {
            const d = e.data || {};
            if (d.type === 'run') {
                const out = runWith(d.globals || {}, d.code || '');
                parent.postMessage({ type: 'log', payload: out }, '*');
                return;
            }
            if (d.type === 'test') {
                const code = d.code || '';
                const base = d.baseGlobals || {};
                const results = [];
                for (const c of (d.cases || [])) {
                    const globals = Object.assign({}, base, c.input || {});
                    let actual, passed = false, error = null;
                    try {
                        runWith(globals, code);
                        actual = (new Function('"use strict"; return (' + c.expr + ')'))();
                        passed = deepEqual(actual, c.equals);
                    } catch (err) { error = err && err.message ? err.message : String(err); }
                    results.push({ pass: passed, expr: c.expr, expected: c.equals, actual, error });
                }
                parent.postMessage({ type: 'testResult', results }, '*');
            }
        };
    })();
</script>
</body>
</html>